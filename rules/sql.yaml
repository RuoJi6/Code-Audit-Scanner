language: SQL
version: "1.0"
description: "SQL语句基本检测规则"

rules:
  critical:
    # 危险的数据库操作
    - name: "DROP DATABASE"
      function: "DROP DATABASE"
      description: "DROP DATABASE 删除数据库"
      regex: false
      pattern: "DROP DATABASE"
      caseSensitive: false

    - name: "DROP SCHEMA"
      function: "DROP SCHEMA"
      description: "DROP SCHEMA 删除模式"
      regex: false
      pattern: "DROP SCHEMA"
      caseSensitive: false

    - name: "DROP TABLE"
      function: "DROP TABLE"
      description: "DROP TABLE 删除表"
      regex: false
      pattern: "DROP TABLE"
      caseSensitive: false

    - name: "TRUNCATE TABLE"
      function: "TRUNCATE TABLE"
      description: "TRUNCATE TABLE 清空表数据"
      regex: false
      pattern: "TRUNCATE TABLE"
      caseSensitive: false

    - name: "TRUNCATE"
      function: "TRUNCATE"
      description: "TRUNCATE 清空数据"
      regex: true
      pattern: "TRUNCATE\\s+\\w+"
      caseSensitive: false

    - name: "DELETE FROM"
      function: "DELETE FROM"
      description: "DELETE FROM 删除数据"
      regex: true
      pattern: "DELETE\\s+FROM"
      caseSensitive: false

  high:
    # 表结构修改
    - name: "ALTER TABLE"
      function: "ALTER TABLE"
      description: "ALTER TABLE 修改表结构"
      regex: false
      pattern: "ALTER TABLE"
      caseSensitive: false

    - name: "DROP COLUMN"
      function: "DROP COLUMN"
      description: "DROP COLUMN 删除列"
      regex: false
      pattern: "DROP COLUMN"
      caseSensitive: false

    - name: "ALTER COLUMN"
      function: "ALTER COLUMN"
      description: "ALTER COLUMN 修改列定义"
      regex: false
      pattern: "ALTER COLUMN"
      caseSensitive: false
    # 系统命令
    - name: "xp_cmdshell"
      function: "xp_cmdshell"
      description: "xp_cmdshell 执行系统命令"
      regex: false
      pattern: "xp_cmdshell"
      caseSensitive: false

  medium:
    # 数据查询
    - name: "SELECT"
      function: "SELECT"
      description: "SELECT 查询数据"
      regex: true
      pattern: "\\bSELECT\\s+"
      caseSensitive: false

    # 数据修改
    - name: "UPDATE"
      function: "UPDATE"
      description: "UPDATE 更新数据"
      regex: true
      pattern: "UPDATE\\s+\\w+"
      caseSensitive: false

    - name: "INSERT INTO"
      function: "INSERT INTO"
      description: "INSERT INTO 插入数据"
      regex: true
      pattern: "INSERT\\s+INTO"
      caseSensitive: false

    - name: "REPLACE INTO"
      function: "REPLACE INTO"
      description: "REPLACE INTO 替换插入数据"
      regex: false
      pattern: "REPLACE INTO"
      caseSensitive: false

    # 表创建
    - name: "CREATE TABLE"
      function: "CREATE TABLE"
      description: "CREATE TABLE 创建表"
      regex: true
      pattern: "CREATE\\s+TABLE"
      caseSensitive: false

    # 用户管理
    - name: "CREATE USER"
      function: "CREATE USER"
      description: "CREATE USER 创建用户"
      regex: false
      pattern: "CREATE USER"
      caseSensitive: false

    - name: "DROP USER"
      function: "DROP USER"
      description: "DROP USER 删除用户"
      regex: false
      pattern: "DROP USER"
      caseSensitive: false

    - name: "ALTER USER"
      function: "ALTER USER"
      description: "ALTER USER 修改用户"
      regex: false
      pattern: "ALTER USER"
      caseSensitive: false


    # 锁操作
    - name: "LOCK TABLES"
      function: "LOCK TABLES"
      description: "LOCK TABLES 锁定表"
      regex: false
      pattern: "LOCK TABLES"
      caseSensitive: false

    - name: "UNLOCK TABLES"
      function: "UNLOCK TABLES"
      description: "UNLOCK TABLES 解锁表"
      regex: false
      pattern: "UNLOCK TABLES"
      caseSensitive: false

  low:
    # 连接操作
    - name: "JOIN"
      function: "JOIN"
      description: "JOIN 连接查询"
      regex: true
      pattern: "(?:INNER\\s+)?JOIN"
      caseSensitive: false

    - name: "LEFT JOIN"
      function: "LEFT JOIN"
      description: "LEFT JOIN 左连接查询"
      regex: true
      pattern: "LEFT\\s+(?:OUTER\\s+)?JOIN"
      caseSensitive: false

    - name: "RIGHT JOIN"
      function: "RIGHT JOIN"
      description: "RIGHT JOIN 右连接查询"
      regex: true
      pattern: "RIGHT\\s+(?:OUTER\\s+)?JOIN"
      caseSensitive: false

    - name: "FULL JOIN"
      function: "FULL JOIN"
      description: "FULL JOIN 全连接查询"
      regex: true
      pattern: "FULL\\s+(?:OUTER\\s+)?JOIN"
      caseSensitive: false

    - name: "CROSS JOIN"
      function: "CROSS JOIN"
      description: "CROSS JOIN 交叉连接"
      regex: false
      pattern: "CROSS JOIN"
      caseSensitive: false

    # 集合操作
    - name: "UNION"
      function: "UNION"
      description: "UNION 联合查询"
      regex: true
      pattern: "UNION(?!\\s+ALL)"
      caseSensitive: false

    - name: "UNION ALL"
      function: "UNION ALL"
      description: "UNION ALL 联合查询（含重复）"
      regex: false
      pattern: "UNION ALL"
      caseSensitive: false

    # 聚合函数
    - name: "COUNT"
      function: "COUNT"
      description: "COUNT 计数统计"
      regex: true
      pattern: "COUNT\\s*\\("
      caseSensitive: false

    - name: "SUM"
      function: "SUM"
      description: "SUM 求和统计"
      regex: true
      pattern: "SUM\\s*\\("
      caseSensitive: false

    - name: "AVG"
      function: "AVG"
      description: "AVG 平均值统计"
      regex: true
      pattern: "AVG\\s*\\("
      caseSensitive: false

    - name: "MAX"
      function: "MAX"
      description: "MAX 最大值统计"
      regex: true
      pattern: "MAX\\s*\\("
      caseSensitive: false

    - name: "MIN"
      function: "MIN"
      description: "MIN 最小值统计"
      regex: true
      pattern: "MIN\\s*\\("
      caseSensitive: false

    # 分组和排序
    - name: "GROUP BY"
      function: "GROUP BY"
      description: "GROUP BY 分组查询"
      regex: false
      pattern: "GROUP BY"
      caseSensitive: false

    - name: "ORDER BY"
      function: "ORDER BY"
      description: "ORDER BY 排序查询"
      regex: false
      pattern: "ORDER BY"
      caseSensitive: false

    - name: "HAVING"
      function: "HAVING"
      description: "HAVING 分组筛选"
      regex: false
      pattern: "HAVING"
      caseSensitive: false

    # 去重和限制
    - name: "DISTINCT"
      function: "DISTINCT"
      description: "DISTINCT 去重查询"
      regex: false
      pattern: "DISTINCT"
      caseSensitive: false

    - name: "LIMIT"
      function: "LIMIT"
      description: "LIMIT 限制结果数量"
      regex: false
      pattern: "LIMIT"
      caseSensitive: false

    - name: "OFFSET"
      function: "OFFSET"
      description: "OFFSET 偏移查询"
      regex: false
      pattern: "OFFSET"
      caseSensitive: false

    - name: "TOP"
      function: "TOP"
      description: "TOP 限制结果数量"
      regex: true
      pattern: "SELECT\\s+TOP"
      caseSensitive: false

    # 子查询
    - name: "IN"
      function: "IN"
      description: "IN 子查询或列表匹配"
      regex: true
      pattern: "\\bIN\\s*\\("
      caseSensitive: false

    - name: "NOT IN"
      function: "NOT IN"
      description: "NOT IN 子查询或列表排除"
      regex: true
      pattern: "NOT\\s+IN\\s*\\("
      caseSensitive: false

    - name: "EXISTS"
      function: "EXISTS"
      description: "EXISTS 存在性子查询"
      regex: true
      pattern: "\\bEXISTS\\s*\\("
      caseSensitive: false

    - name: "NOT EXISTS"
      function: "NOT EXISTS"
      description: "NOT EXISTS 不存在性子查询"
      regex: true
      pattern: "NOT\\s+EXISTS\\s*\\("
      caseSensitive: false

    # 视图
    - name: "CREATE VIEW"
      function: "CREATE VIEW"
      description: "CREATE VIEW 创建视图"
      regex: true
      pattern: "CREATE\\s+(?:OR\\s+REPLACE\\s+)?VIEW"
      caseSensitive: false

    - name: "DROP VIEW"
      function: "DROP VIEW"
      description: "DROP VIEW 删除视图"
      regex: false
      pattern: "DROP VIEW"
      caseSensitive: false

    # 索引
    - name: "CREATE INDEX"
      function: "CREATE INDEX"
      description: "CREATE INDEX 创建索引"
      regex: true
      pattern: "CREATE\\s+(?:UNIQUE\\s+)?INDEX"
      caseSensitive: false

    - name: "DROP INDEX"
      function: "DROP INDEX"
      description: "DROP INDEX 删除索引"
      regex: false
      pattern: "DROP INDEX"
      caseSensitive: false

    # 临时表
    - name: "CREATE TEMPORARY TABLE"
      function: "CREATE TEMPORARY TABLE"
      description: "CREATE TEMPORARY TABLE 创建临时表"
      regex: true
      pattern: "CREATE\\s+(?:TEMPORARY|TEMP)\\s+TABLE"
      caseSensitive: false

    # 存储过程
    - name: "CREATE PROCEDURE"
      function: "CREATE PROCEDURE"
      description: "CREATE PROCEDURE 创建存储过程"
      regex: true
      pattern: "CREATE\\s+(?:OR\\s+REPLACE\\s+)?PROCEDURE"
      caseSensitive: false

    - name: "DROP PROCEDURE"
      function: "DROP PROCEDURE"
      description: "DROP PROCEDURE 删除存储过程"
      regex: false
      pattern: "DROP PROCEDURE"
      caseSensitive: false

    # 函数
    - name: "CREATE FUNCTION"
      function: "CREATE FUNCTION"
      description: "CREATE FUNCTION 创建函数"
      regex: true
      pattern: "CREATE\\s+(?:OR\\s+REPLACE\\s+)?FUNCTION"
      caseSensitive: false

    - name: "DROP FUNCTION"
      function: "DROP FUNCTION"
      description: "DROP FUNCTION 删除函数"
      regex: false
      pattern: "DROP FUNCTION"
      caseSensitive: false

    # 触发器
    - name: "CREATE TRIGGER"
      function: "CREATE TRIGGER"
      description: "CREATE TRIGGER 创建触发器"
      regex: true
      pattern: "CREATE\\s+(?:OR\\s+REPLACE\\s+)?TRIGGER"
      caseSensitive: false

    - name: "DROP TRIGGER"
      function: "DROP TRIGGER"
      description: "DROP TRIGGER 删除触发器"
      regex: false
      pattern: "DROP TRIGGER"
      caseSensitive: false

    # 并发控制
    - name: "FOR UPDATE"
      function: "FOR UPDATE"
      description: "FOR UPDATE 行锁查询"
      regex: false
      pattern: "FOR UPDATE"
      caseSensitive: false

    - name: "LOCK IN SHARE MODE"
      function: "LOCK IN SHARE MODE"
      description: "LOCK IN SHARE MODE 共享锁查询"
      regex: false
      pattern: "LOCK IN SHARE MODE"
      caseSensitive: false

    # 数据库操作
    - name: "CREATE DATABASE"
      function: "CREATE DATABASE"
      description: "CREATE DATABASE 创建数据库"
      regex: false
      pattern: "CREATE DATABASE"
      caseSensitive: false

    - name: "USE"
      function: "USE"
      description: "USE 切换数据库"
      regex: true
      pattern: "USE\\s+\\w+"
      caseSensitive: false

    - name: "SHOW DATABASES"
      function: "SHOW DATABASES"
      description: "SHOW DATABASES 显示数据库列表"
      regex: false
      pattern: "SHOW DATABASES"
      caseSensitive: false

    - name: "SHOW TABLES"
      function: "SHOW TABLES"
      description: "SHOW TABLES 显示表列表"
      regex: false
      pattern: "SHOW TABLES"
      caseSensitive: false

    - name: "DESCRIBE"
      function: "DESCRIBE"
      description: "DESCRIBE 查看表结构"
      regex: true
      pattern: "(?:DESCRIBE|DESC)\\s+\\w+"
      caseSensitive: false
